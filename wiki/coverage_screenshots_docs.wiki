#summary UNDER CONSTRUCTION: Documentation for coverage_screenshots.py

<wiki:toc max_depth="2" />

= Introduction  & Description =

----
http://bioinformatics-misc.googlecode.com/svn/wiki/images/screenshot.jpg
----

*coverage_screenshots.py* produces coverage files and plots for one or more bam
files at the intervals specified in a bed file. Plots are written in pdf format, one per
region or they can be concatenated in a single file.

Plots can be annotated according to a GTF file and decorated with the individual
nucleotides if a corresponding reference FASTA file is provided.

In contrast to most genome browsers (IGV, IGB etc.) `coverage_screenshots.py`
is deliberately designed to be avoid any graphical user interface so that it can be
included in script and pipelines and can be run on enviroments not designed to
support GUIs (e.g. computer farms). The graphical output can be customized via
several options passed to R.

Some implementation details: The heavy duty task of counting nucleotides at each
position is performed by `samtools mpileup`so it is reasonably fast. Interval
operations are executed by [http://pythonhosted.org/pybedtools/ pybedtools]. If
the size of the interval exceeds a set limit (`--nwinds`), the interval is divided
in equally sized windows and the nucleotide counts averaged by window (See coverage_screenshots_docs#Example_3:_Re-plotting).

Plotting is done by the [http://cran.r-project.org/ R] standard library.

*Remember* If you save the intermediate output directory (`--tmpdir`), you can replot
the data without going through the expensive operation of counting depth and bases.

= System Requirements & Installation =

`coverage_screenshots.py` lives at http://bioinformatics-misc.googlecode.com/svn/trunk/coverage_screenshots.py.
A package to download is at [_in prep_].

All the components that make `coverage_screenshots.py` are freely available from
the net.

    * *python 2.7* Version 2.5+ should do, 3.x not yet.
    * [http://samtools.sourceforge.net/ samtools 0.1.18] other reasonably new versions should do.
    * [http://cran.r-project.org/ R] (Actually `Rscript`) to be found on your `$PATH`
    * *Linux/Unix* Windows might be working via Cygwin (see also [http://pythonhosted.org/pybedtools/main.html pybedtools]).

== Required python packages ==

    * [http://docs.python.org/dev/library/argparse.html argparse] Already included in python 2.7 standard library
    * [http://pythonhosted.org/pybedtools/ pybedtools]
    * [https://pypi.python.org/pypi/PyPDF2 PyPDF2] _Optional_: Only used to concatenate all PDF files in a single one (`--onefile`).

== Installation ==

Assuming the requirements above are satisfied there isn't really any installation to be done.
Just download, unzip, and copy `coverage_screenshots.py` to a directory of your convenience
{{{
tar zxvf coverage_screenshots-x.x.x.tar.gz
cd coverage_screenshots-x.x.x
cp coverage_screenshots.py ~/bin/
}}}

= Required input =

The necessary input files are:

    * *BAM* files *sorted* and *indexed* (see above how to)

    * *BED* file of regions to compute and plot coverage for. Bed file should be tab separated and have at least three columns for chrom, start and end position. An addtional column with the feature name might be included and will be part of the output file names. Addtional columns are ignored.

    * _Optional_ *GTF/GFF/BED* file with annotation to be displayed. Such files can be obtained from UCSC, ENSEMBL or custom made. Make sure chromosome names are consistent across files!
 
    * _Optional_ *FASTA* file of the reference sequence used to produce the alignments. Only needed to display the sequence of the interval.

See also [https://genome.ucsc.edu/FAQ/FAQformat.html UCSC] for description if file formats.

_MEMO_ You can sort and index a bam file, assuming you have samtools (http://samtools.sourceforge.net/), with

{{{
samtools sort myfile.bam myfile_sort
samtools index myfile_sort.bam
}}}  

= Description of output =

Intermediate output files, including the R script used to generate the plots,
can be saved for future inspection. The following files are generated for *each*
bed interval:

    * `*.mpileup.bed.txt`
        Coverage and nucleotide counts (or rpm) at each postion in the interval
    * `*.grp.bed.txt`
        Coverage and nucleotide counts (or rpm) averaged by equally sized windows
    * `*.seq.txt`
        Base at each position in the interval (if a fasta file is provided (`--fasta`) and
        the region size does not exceed the requested limit (`--max_fa` option) )
    * `*.annot.txt`
        Annotation file with GTF features intersected by this bed interval.
    * `*.R`
        R script to produce the PDF files.
    * `*.pdf`
        PDF file of the plots

Files are named according to the bed interval from which they come (`chrom_start_end[_name]` e.g. _chr7_5566644_5570292_ACTB.pdf_).

For example, the following execution
{{{
coverage_screenshots.py --ibam *.bam --gtf genes.gtf.gz --bed actb.bed --rpm 
}}}

will plot the coverage of all the bam files in the current directory at the
postions specified in the bed file `actb.bed`. It will also add the postions of
exons and CDSs as reported in `genes.gtf.gz`. with `--rpm` coverage is reported as
_reads per million_.

Keep in mind that each interval (row) in the input bed file produces 5 or 6 files.
Consider this before passing the whole of human refseq to coverge_sscreenshots. 

----
http://bioinformatics-misc.googlecode.com/svn/wiki/images/chr7_5566757_5566829_ACTB.jpg

Example output from `coverage_screenshots.py` with annotation and colour code nucleotide counts.
----

= Usage & Examples =

The source directory contains data files for testing and examples
{{{
cd example
cat actb.bed
    chr7	5566757	5566829	ACTB
    chr7	5566755	5567571	ACTB
    chr7	5566644	5570292	ACTB
}}}
To see all the available options and get help
{{{    
coverage_screenshots.py -h
}}}

== Example 1: Vanilla ==

The minimum necessary to produce coverage plots is bam files *sorted* and *indexed* and
a bed file of positions to capture. (In fact, bam files are not necessary if you want to re-plot
existing data, see below)
{{{
coverage_screenshots.py -i bam/ds0*.bam -b actb.bed
}}}
Default settings plot raw read counts scaling each region to the maximum of all the
files.

== Example 2: Adding annotation ==

Now, rescale coverage to reads per million (RPM) and set the y-axis to 40000 rpm. Also add annotation
of exons and CDSs in the target intervals and report the underlying nucleotide sequence. Sequence is
reported if the target region is smaller than `--max_fa` bp. Finally, concatenate the files in a single pdf (requires `PyPDF2 <https://pypi.python.org/pypi/PyPDF2/>`_ package)
{{{
coverage_screenshots.py -i bam/ds0*.bam \
    -b actb.bed \
    -g genes.gtf \
    -f chr7.fa \
    --onefile actb_pdf/actb.pdf \
    --rpm \
    --ylim 40000 \
    --tmpdir wdir
}}}
Intermediate files have been saved for future use under directory `wdir`.

== Example 3: Re-plotting ==

Since computing coverage can be expensive, we don't need to do it again if all we
want is to change the graphical output. If we saved the intermediate output files
from a previous run by seeting `--tmpdir`, we can re-use them with option `--replot`
and change the graphical settings to our liking.
{{{
coverage_screenshots.py -b actb.bed --tmpdir wdir --rpm \
    --col_cov pink \
    --pwidth 12 \
    --psize 12 \
    --cex_seq 0.6 \
    --col_seq darkred \
    --onefile actb_pdf/actb-2.pdf \
    --replot
}}}

Note that it is no longer necessary to give the bam, gtf, and fasta files. All we need
to `replot` is the original bed file, possibly with some rows removed if
we don't want them anymore, and the working directory where the previously
generated files are  (`--tmpdir`).

----
http://bioinformatics-misc.googlecode.com/svn/wiki/images/chr7_5566644_5570292_ACTB.jpg

Example of RNA-Seq data for the ACTB gene with colour coded samples (`--bg` opt)
and coarse resolution (`--nwinds` opt).
----

= Some tips =

=== Colours ===

The colours passed to `coverage_screenshots.py` are in turn passed to R verbatim,
therefore any R colour name or format is valid. R understands most English names of
colours (_red_, _lightblue_ etc.) as well as the RGB representation (e.g. `#0000FF`, `00255`).
See this nice [http://research.stowers-institute.org/efg/R/Color/Chart/ColorChart.pdf chart]
for many colour options.

Transparent colours often show up better in graphics. To add transperncy to an R colour, use
this function (credit [http://stackoverflow.com/questions/8047668/transparent-equivalent-of-given-color stackoverflow])

{{{
makeTransparent<-function(someColor, alpha=100){
    newColor<-col2rgb(someColor)
    apply(newColor, 2, function(curcoldata){rgb(red=curcoldata[1], green=curcoldata[2],
    blue=curcoldata[3],alpha=alpha, maxColorValue=255)})
}
makeTransparent('red', 50) >>> '#FF000032'
}}}

=== Converting PDF ===

To convert PDF images to jpg you can use the [http://www.imagemagick.org/script/convert.php convert] tool from [http://www.imagemagick.org/script/index.php ImageMagick]
like this:
{{{
convert -density 300 chr7_5566757_5566829_ACTB.pdf chr7_5566757_5566829_ACTB.jpg
}}}